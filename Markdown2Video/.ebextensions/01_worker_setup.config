# .ebextensions/01_worker_setup.config
# Configura el entorno para el worker de video

packages:
  dnf:
    # Instala FFmpeg, la herramienta clave para la manipulación de video
    ffmpeg: []

files:
  # Crea el archivo de servicio de systemd para nuestro worker de PHP.
  # Systemd se encargará de que este script siempre esté corriendo.
  "/etc/systemd/system/video_worker.service":
    mode: "000644"
    owner: root
    group: root
    content: |
      [Unit]
      Description=Markdown2Video PHP Worker
      After=network.target

      [Service]
      Type=simple
      # El usuario 'webapp' es el usuario por defecto en entornos de Elastic Beanstalk
      User=webapp
      Group=webapp
      # Ruta al script que crearemos en pasos futuros
      ExecStart=/usr/bin/php /var/app/current/worker/video_worker.php
      # Reiniciar el servicio automáticamente si falla
      Restart=always
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

# Comandos que se ejecutan en el contenedor después de que el código se despliega
container_commands:
  01_reload_daemon:
    command: "sudo systemctl daemon-reload"
  02_enable_worker_service:
    command: "sudo systemctl enable video_worker.service"
  03_restart_worker_service:
    # Usamos 'restart' para que en cada despliegue se reinicie el worker
    # y utilice el código más reciente.
    command: "sudo systemctl restart video_worker.service"
